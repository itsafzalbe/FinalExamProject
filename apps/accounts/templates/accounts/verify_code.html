{% extends 'accounts/base.html' %}

{% block title %}Verify Email - Personal Finance Tracker{% endblock %}

{% block content %}
<div class="logo">
    <div class="logo-icon">✉️</div>
    <h1>Personal Finance Tracker</h1>
</div>

<div class="step-indicator">
    <div class="step active"></div>
    <div class="step active"></div>
    <div class="step"></div>
</div>

<h2>Verify Your Email</h2>
<p class="subtitle">Enter the 4-digit code sent to<br><strong>{{ email }}</strong></p>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" id="verifyForm">
    {% csrf_token %}
    <input type="hidden" name="email" value="{{ email }}">
    
    <div class="code-input-container">
        <input type="text" class="code-digit" maxlength="1" id="digit1" name="digit1" required>
        <input type="text" class="code-digit" maxlength="1" id="digit2" name="digit2" required>
        <input type="text" class="code-digit" maxlength="1" id="digit3" name="digit3" required>
        <input type="text" class="code-digit" maxlength="1" id="digit4" name="digit4" required>
    </div>

    <button type="submit" class="btn btn-primary" id="submitBtn">
        Verify Code
    </button>
</form>

<button class="btn btn-secondary" id="resendBtn">
    Resend Code
</button>

<div class="timer" id="timer">
    Resend available in <span class="timer-count" id="countdown">120</span>s
</div>

<p class="link-text">
    <a href="{% url 'accounts:signup' %}">Use different email</a>
</p>

<script>
    // Auto-focus and auto-advance code inputs
    const inputs = document.querySelectorAll('.code-digit');
    
    inputs.forEach((input, index) => {
        input.addEventListener('input', function() {
            if (this.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value === '' && index > 0) {
                inputs[index - 1].focus();
            }
        });

        // Only allow numbers
        input.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    });

    // Focus first input
    inputs[0].focus();

    // Form submission
    const form = document.getElementById('verifyForm');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const code = Array.from(inputs).map(input => input.value).join('');
        
        if (code.length !== 4) {
            alert('Please enter all 4 digits');
            return;
        }

        // Create hidden input for code
        const codeInput = document.createElement('input');
        codeInput.type = 'hidden';
        codeInput.name = 'code';
        codeInput.value = code;
        form.appendChild(codeInput);

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span>';
        form.submit();
    });

    // Resend code timer
    const resendBtn = document.getElementById('resendBtn');
    const timer = document.getElementById('timer');
    const countdown = document.getElementById('countdown');
    let timeLeft = 120;

    resendBtn.disabled = true;
    resendBtn.style.display = 'none';

    const timerInterval = setInterval(() => {
        timeLeft--;
        countdown.textContent = timeLeft;

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timer.style.display = 'none';
            resendBtn.style.display = 'block';
            resendBtn.disabled = false;
        }
    }, 1000);

    // Resend code
    resendBtn.addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<span class="loading"></span>';
        
        fetch('/api/auth/resend-code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: '{{ email }}' })
        })
        .then(response => response.json())
        .then(data => {
            alert('New code sent to your email!');
            location.reload();
        })
        .catch(error => {
            alert('Failed to resend code. Please try again.');
            this.disabled = false;
            this.textContent = 'Resend Code';
        });
    });
</script>
{% endblock %}